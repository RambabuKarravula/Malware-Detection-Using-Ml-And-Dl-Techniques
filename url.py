import requests
import validators
import os

def apicheck():
    api = '981090997e7b6e0a8dd16c457ec43b98a65f22bb69f60dd55f11d61f8bf52fd4'
    url = 'https://www.virustotal.com/vtapi/v2/url/report'
    params = {'apikey': api, 'url': "https://google.com" }
    try:
        requests.get(url, params=params)
        print("valid api code")
        return api
    except Exception:
        print("that api code does not seem to be valid please try again")
        return apicheck()

def pickurlandchecking():
    inputforurl = input("enter a url to scan: ")
    if not inputforurl.startswith("http"):
        inputforurl = "http://" + inputforurl
    if validators.url(inputforurl):
        try:
            requests.get(inputforurl)
            return inputforurl
        except:
            print("Invalid url please try again")
            return pickurlandchecking()
    else:
        print("Invalid url please try again")
        return pickurlandchecking()

def scanning(api, inputforurl):
    url = 'https://www.virustotal.com/vtapi/v2/url/scan'
    params = {'apikey': api, 'url': inputforurl }
    response = requests.post(url, data=params)
    return response.json().get('scan_id')

def report(api, ID):
    url = 'https://www.virustotal.com/vtapi/v2/url/report'
    params = {'apikey': api, 'resource': ID }
    response = requests.get(url, params=params)
    return response.json()

def shorten(permalink):
    try:
        res = requests.get("http://tinyurl.com/api-create.php?url=" + permalink)
        return res.text
    except Exception as e:
        print(e)

def makeitlooknicer(res):
    permalink = res.get('permalink')
    shorturl = shorten(permalink)
    ress = res.get('scans')
    yan = ress.get('Yandex Safebrowsing')
    mal = ress.get('MalwareDomainList')
    if yan is not None:
        yan.pop('detail', None)
    if mal is not None:
        mal.pop('detail', None)
    char_to_replace = {": {'detected': True, 'result': 'malicious site'},": " thinks this site is malicious",
                       ": {'detected': False, 'result': 'clean site'},": " thinks this site is clean",
                       ": {'detected': False, 'result': 'unrated site'},": " does not know the proper rating of this site",
                       "'": ""}
    repleaced = str(ress).replace("},", "}, \n")[1:][:-1] + ","
    for key, value in char_to_replace.items():
        repleaced = repleaced.replace(key, value)
    repleaced = repleaced + "\n The URL to VirusTotal scan results is: " + permalink + " or " + shorturl
    done = ""
    for line in repleaced.splitlines():
        if line[0:1] == " ":
            done = done + line[1:] + "\n"
        else:
            done = done + line + "\n"
    return done

def main():
    try:
        api = apicheck()
        inputforurl = pickurlandchecking()
        ID = scanning(api, inputforurl)    
        res = report(api, ID)
        repleaced = makeitlooknicer(res)
        print(repleaced)
    except Exception as e:
        print("a unknown error has occurred please try again later...")
        print(e)

if __name__ == '__main__':
    try:
       main()
    except KeyboardInterrupt:
        os.system("cls")
        print("exiting program...")